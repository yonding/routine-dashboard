<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì¼ìƒ ë£¨í‹´ ëŒ€ì‹œë³´ë“œ</title>
<link rel="manifest" href="./manifest.webmanifest">
<meta name="theme-color" content="#0f1220">
<style>
  :root{
    --bg:#0f1220; --card:#171a2b; --muted:#8a8fa3; --text:#eef1ff; --accent:#6ea8fe; --good:#30d158; --warn:#ff9f0a; --bad:#ff453a;
  }
  *{box-sizing:border-box}
  body{
    margin:0; padding:16px; background:var(--bg); color:var(--text);
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Helvetica,Arial,sans-serif;
  }
  h1{font-size:22px; margin:0 0 8px}
  .row{display:grid; gap:12px}
  @media(min-width:900px){ .row{grid-template-columns:1.1fr .9fr} }
  .card{background:var(--card); border-radius:14px; padding:14px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .muted{color:var(--muted)}
  .pill{display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; margin-right:6px; background:#222740; color:#cbd1ff}
  .btn{cursor:pointer; border:none; padding:10px 12px; border-radius:10px; background:var(--accent); color:#081028; font-weight:600}
  .btn.secondary{background:#2a2f4d; color:#cfe0ff}
  .btn.ghost{background:transparent; border:1px solid #394063; color:#cfe0ff}
  .btn:disabled{opacity:.6; cursor:not-allowed}
  .grid{display:grid; gap:8px}
  .timeline{position:relative; height:18px; background:#1d2240; border-radius:999px; overflow:hidden}
  .timeline .fill{position:absolute; left:0; top:0; bottom:0; background:linear-gradient(90deg,#6ea8fe,#9a7bff); width:0%}
  .block{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px 12px; border:1px solid #2a2f4d; border-radius:12px}
  .block.active{border-color:#6ea8fe; background:rgba(110,168,254,.07)}
  .block .when{font-weight:600}
  .tag{font-size:12px; color:#b9c2ff}
  .flex{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .section-title{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px}
  input[type="number"], input[type="text"], select{
    background:#1d2240; color:#eaf0ff; border:1px solid #303761; border-radius:10px; padding:8px 10px; width:100%;
  }
  .table{width:100%; border-collapse:collapse; font-size:14px}
  .table th,.table td{padding:8px; border-bottom:1px solid #2a2f4d; text-align:left}
  .tiny{font-size:12px}
  .success{color:var(--good)} .warn{color:var(--warn)} .bad{color:var(--bad)}
  .kbd{background:#2a2f4d; color:#cfe0ff; padding:2px 6px; border-radius:6px; font-size:12px}
</style>
</head>
<body>
  <h1>ğŸ“† ì¼ìƒ ë£¨í‹´ ëŒ€ì‹œë³´ë“œ</h1>
  <div class="row">
    <section class="card">
      <div class="section-title">
        <div>
          <div class="muted tiny">í˜„ì¬ ì‹œê°„ëŒ€</div>
          <div id="nowLabel" style="font-size:18px; font-weight:700">-</div>
        </div>
        <div class="pill" id="nowTime">--:--</div>
      </div>
      <div class="timeline"><div class="fill" id="progressFill"></div></div>
      <div id="blocks" class="grid" style="margin-top:10px"></div>
      <div class="flex" style="margin-top:8px">
        <button class="btn" id="markDoneBtn">ì§€ê¸ˆ ë¸”ë¡ ì™„ë£Œ</button>
        <button class="btn ghost" id="exportCSV">ê¸°ë¡ CSV</button>
      </div>
      <div class="tiny muted" style="margin-top:6px">ì™„ë£Œ ì‹œê°ì´ ìë™ ê¸°ë¡ë©ë‹ˆë‹¤.</div>
    </section>

    <div class="grid">
      <section class="card">
        <div class="section-title">
          <div style="font-size:18px; font-weight:700">ğŸš€ ì‘ì—… ë£¨í‹´</div>
        </div>
        <div class="grid">
          <button class="btn secondary" id="startWorkRoutineBtn">ìœ íŠœë¸Œ ì˜ìƒ + ë®¤ì§ ì¼œê¸°</button>
        </div>
        <div class="tiny muted" style="margin-top:6px">ì˜¤í† ë°”ì´ ì£¼í–‰ ì˜ìƒê³¼ ìœ íŠœë¸Œ ë®¤ì§ì„ ìƒˆ íƒ­ì—ì„œ ì—½ë‹ˆë‹¤.</div>
      </section>

      <section class="card">
        <div class="section-title">
          <div>
            <div class="muted tiny">ì˜¤ëŠ˜ì˜ ìš´ë™</div>
            <div id="todayWorkoutTitle" style="font-size:18px; font-weight:700">-</div>
          </div>
          <div class="pill" id="weekdayPill">-</div>
        </div>
        <div id="workoutList" class="grid"></div>
        <div class="flex" style="margin-top:10px">
          <button class="btn secondary" id="addSet">ì„¸íŠ¸ ì¶”ê°€</button>
          <button class="btn ghost" id="copyLast">ì§€ë‚œ ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        </div>
        <table class="table" style="margin-top:10px">
          <thead><tr><th>ìš´ë™</th><th>kg</th><th>reps</th><th>ì„¸íŠ¸</th><th>ì‹œê°„</th></tr></thead>
          <tbody id="logBody"></tbody>
        </table>
      </section>
    </div>
  </div>

  <section class="card" style="margin-top:12px">
    <div class="section-title">
      <div style="font-weight:700">ê¸°ë¡</div>
      <div class="pill" id="todaySummary">-</div>
    </div>
    <div id="history" class="grid"></div>
  </section>

<script>
// ===== Config =====
const dayBlocks0= [
  {label:"ê¸°ìƒÂ·ë¬¼Â·ìŠ¤íŠ¸ë ˆì¹­", start:"07:00", end:"07:15", key:"wake"},
  {label:"ì•„ì¹¨ ìš´ë™ (ì›¨ì´íŠ¸+ìœ ì‚°ì†Œ)", start:"07:15", end:"08:45", key:"train"},
  {label:"ìƒ¤ì›ŒÂ·ì •ë¦¬", start:"08:45", end:"09:30", key:"prep"},
  {label:"ì²« ë‹¨ë°±ì§ˆ/WPI + ì˜ì–‘ì œ", start:"09:30", end:"09:40", key:"protein"},
  {label:"Deep Work 1", start:"09:40", end:"11:30", key:"deep1"},
  {label:"ì ì‹¬ (ì²« ì‹ì‚¬)", start:"11:30", end:"12:00", key:"lunch"},
  {label:"ì¶œê·¼Â·ì—…ë¬´", start:"12:30", end:"18:30", key:"work"},
  {label:"ì €ë…", start:"19:00", end:"19:30", key:"dinner"},
  {label:"Deep Work 2", start:"19:30", end:"21:00", key:"deep2"},
  {label:"ì‚°ì±…Â·ìŠ¤íŠ¸ë ˆì¹­", start:"21:00", end:"21:30", key:"walk"},
  {label:"ì·¨ì¹¨ ì¤€ë¹„(ë§ˆê·¸ë„¤ìŠ˜Â·í…Œì•„ë‹Œ)", start:"22:30", end:"23:00", key:"prebed"},
  {label:"ì·¨ì¹¨", start:"23:00", end:"23:59", key:"sleep"}
];

const dayBlocks = [
  {label:"ê¸°ìƒ", start:"07:30", end:"07:45", key:"wake"},
  {label:"ì•„ì¹¨ ìš´ë™", start:"07:45", end:"9:00", key:"train"},
  {label:"ìƒ¤ì›ŒÂ·ì¶œê·¼", start:"09:00", end:"09:30", key:"prep"},
  {label:"ì•„ì¹¨ì‹ì‚¬(ê³„ë€2ê°œÂ·ìš”ê±°íŠ¸Â·ê·¸ë˜ë†€ë¼)", start:"09:30", end:"10:00", key:"protein"},
  {label:"Deep Work I (ë…¼ë¬¸ì½ê¸°)", start:"10:00", end:"12:30", key:"deep1"},
  {label:"ì ì‹¬ì‹ì‚¬(ë‹­ê°€ìŠ´ì‚´)Â·ì‚°ì±…", start:"12:30", end:"13:30", key:"lunch"},
  {label:"Deep Work II (ì—°êµ¬)", start:"13:30", end:"18:30", key:"work"},
  {label:"ì €ë…ì‹ì‚¬(ë‹­ê°€ìŠ´ì‚´)Â·ì‚°ì±…", start:"18:30", end:"19:30", key:"dinner"},
  {label:"Deep Work III (ì½”ë”©)", start:"19:30", end:"23:30", key:"deep2"},
  {label:"í‡´ê·¼", start:"23:30", end:"24:00", key:"walk"},
  {label:"ì·¨ì¹¨ ì¤€ë¹„", start:"24:00", end:"24:30", key:"prebed"},
  {label:"ê¸°ë„Â·ì·¨ì¹¨", start:"24:30", end:"25:00", key:"sleep"}
];
const templates = {
  1:{
    title:"ì›” â€” í•˜ì²´Â·ì—‰ë©ì´ A (40ë¶„)",
    items:[
      "ë ˆê·¸í”„ë ˆìŠ¤ 3Ã—12",
      "ê³ ë¸”ë¦¿ ìŠ¤ì¿¼íŠ¸ 2Ã—10",
      "ë¤ë²¨ RDL 2Ã—10",
      "ë ˆê·¸ì»¬ 2Ã—12",
      "í™ì–´ë¸Œë•ì…˜ 2Ã—15",
      "í™ë¸Œë¦¿ì§€ 2Ã—12"
    ]
  },

  2:{
    title:"í™” â€” ìƒì²´ A (ë“±Â·ê°€ìŠ´Â·ì–´ê¹¨)",
    items:[
      "ë«í’€ë‹¤ìš´ 3Ã—12",
      "ì‹œí‹°ë“œ ë¡œìš° 2Ã—12",
      "ì²´ìŠ¤íŠ¸ í”„ë ˆìŠ¤ ë¨¸ì‹  2Ã—12",
      "ìˆ„ë” í”„ë ˆìŠ¤ ë¨¸ì‹  2Ã—10",
      "ë¤ë²¨ ì•”ì»¬ 1Ã—12",
      "íŠ¸ë¼ì´ì…‰ìŠ¤ ë¡œí”„í‘¸ì‹œë‹¤ìš´ 1Ã—12"
    ]
  },

  3:{
    title:"ìˆ˜ â€” íšŒë³µ/ê°€ë²¼ìš´ ì „ì‹ ",
    items:[
      "ìŠ¤í…ì—… 2Ã—12",
      "ìŠ¤ë¯¸ìŠ¤ ìŠ¤ì¿¼íŠ¸ ê°€ë³ê²Œ 2Ã—12",
      "ë°± ìµìŠ¤í…ì…˜ 2Ã—12",
      "í”Œë­í¬ 40ì´ˆ Ã—2",
      "ë°ë“œë²„ê·¸ 2Ã—12"
    ]
  },

  4:{
    title:"ëª© â€” í•˜ì²´Â·ì—‰ë©ì´ B (40ë¶„)",
    items:[
      "ë¤ë²¨ RDL (ì¤‘ëŸ‰â†‘) 3Ã—10",
      "ë ˆê·¸í”„ë ˆìŠ¤(í™ ì§‘ì¤‘) 2Ã—12",
      "ëŸ°ì§€ í˜¹ì€ ë ˆê·¸ìµìŠ¤í…ì…˜ 2Ã—12",
      "í™ì–´ë¸Œë•í„° 2Ã—15",
      "ì¼€ì´ë¸” í‚¥ë°± 1Ã—12"
    ]
  },

  5:{
    title:"ê¸ˆ â€” ìƒì²´ B (ë“± ì¤‘ì‹¬)",
    items:[
      "ë«í’€ë‹¤ìš´ 2Ã—12",
      "ë˜ëŠ” ì‹œí‹°ë“œë¡œìš° 2Ã—10",
      "ì²´ìŠ¤íŠ¸í”„ë ˆìŠ¤ 2Ã—12",
      "ë¤ë²¨ ìˆ„ë”í”„ë ˆìŠ¤ 1~2Ã—10",
      "í˜ì´ìŠ¤í’€ 1Ã—15"
    ]
  }
};


// ===== Storage helpers =====
const store = {
  get k(){ return "routineLogs_v1"; },
  load(){ return JSON.parse(localStorage.getItem(this.k) || '{"blocks":{},"workout":[],"history":[]}'); },
  save(data){ localStorage.setItem(this.k, JSON.stringify(data)); }
};

function fmtHM(d){ return d.toTimeString().slice(0,5); }
function todayKey(){ const d=new Date(); return d.toISOString().slice(0,10); }
function parseTime(hm){
  const [h,m]=hm.split(":").map(Number);
  const d=new Date(); d.setHours(h, m, 0, 0); return d;
}
function pctOf(a,b,c){ return Math.max(0, Math.min(100, ((a-b)/(c-b))*100 )); }

// ===== Render blocks =====
function renderBlocks(){
  const container = document.getElementById("blocks");
  container.innerHTML = "";
  const now = new Date();
  document.getElementById("nowTime").textContent = fmtHM(now);

  const dayStart = parseTime(dayBlocks[0].start).getTime();
  const dayEnd   = parseTime(dayBlocks[dayBlocks.length-1].end).getTime();
  const p = pctOf(now.getTime(), dayStart, dayEnd);
  document.getElementById("progressFill").style.width = p + "%";

  const data = store.load();
  const tkey = todayKey();
  if(!data.blocks[tkey]) data.blocks[tkey] = {};

  let activeIndex=-1;
  dayBlocks.forEach((b, idx)=>{
    const s = parseTime(b.start), e = parseTime(b.end);
    const active = now>=s && now<=e;
    if(active) activeIndex = idx;
    const done = !!data.blocks[tkey][b.key];

    const div = document.createElement("div");
    div.className = "block"+(active?" active":"");
    div.innerHTML = `
      <div>
        <div class="when">${b.start}â€“${b.end} <span class="tag">${b.label}</span></div>
        <div class="tiny ${done?'success':'muted'}">${done?'ì™„ë£Œë¨':'ë¯¸ì™„ë£Œ'}</div>
      </div>
      <div class="flex">
        <button class="btn ${done?'secondary':'ghost'}" data-key="${b.key}">${done?'ì™„ë£Œ ì·¨ì†Œ':'ì™„ë£Œ'}</button>
      </div>
    `;
    div.querySelector("[data-key]").onclick = ()=>{
      const data = store.load();
      const tkey = todayKey();
      if(!data.blocks[tkey]) data.blocks[tkey] = {};
      if(data.blocks[tkey][b.key]){
        delete data.blocks[tkey][b.key];
      } else {
        data.blocks[tkey][b.key] = new Date().toISOString();
      }
      store.save(data); renderBlocks(); renderHistory();
    };
    container.appendChild(div);
  });

  const nowLabel = activeIndex>=0 ? dayBlocks[activeIndex].label : "íœ´ì‹";
  document.getElementById("nowLabel").textContent = nowLabel;
}

// ===== Workout section =====
function renderWorkout(){
  const wd = new Date().getDay();
  const t = templates[wd];
  document.getElementById("weekdayPill").textContent = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "][wd];
  document.getElementById("todayWorkoutTitle").textContent = t ? t.title : "ì˜¤ëŠ˜: íœ´ì‹";
  const list = document.getElementById("workoutList");
  list.innerHTML = "";
  (t?.items||[]).forEach(txt=>{
    const div=document.createElement("div");
    div.className="block";
    div.innerHTML = `<div>${txt}</div><button class="btn ghost" data-ex="${txt}">ê¸°ë¡</button>`;
    div.querySelector("button").onclick = ()=> quickAdd(txt);
    list.appendChild(div);
  });
  const data = store.load();
  const tb = document.getElementById("logBody");
  tb.innerHTML="";
  (data.workout||[]).filter(x=>x.date===todayKey()).forEach(e=>{
    const tr=document.createElement("tr");
    tr.innerHTML = `<td>${e.name}</td><td>${e.kg||""}</td><td>${e.reps||""}</td><td>${e.sets||1}</td><td class="tiny muted">${e.time.slice(11,19)}</td>`;
    tb.appendChild(tr);
  });
}

function quickAdd(name){
  const kg = prompt(`${name}\në¬´ê²Œ(kg)? (ë¹ˆì¹¸ ê°€ëŠ¥)`);
  const reps = prompt(`${name}\në°˜ë³µ ìˆ˜(reps)? (ë¹ˆì¹¸ ê°€ëŠ¥)`);
  addLog({name, kg:kg?Number(kg):"", reps:reps?Number(reps):"", sets:1});
}

function addLog(entry){
  const data = store.load();
  data.workout = data.workout||[];
  data.workout.push({date:todayKey(), time:new Date().toISOString(), ...entry});
  store.save(data);
  renderWorkout(); renderHistory();
}

document.getElementById("addSet").onclick = ()=>{
  const name = prompt("ìš´ë™ ì´ë¦„? (ì˜ˆ: ë²¤ì¹˜í”„ë ˆìŠ¤)");
  if(!name) return;
  const kg = prompt("ë¬´ê²Œ(kg)?"); const reps = prompt("ë°˜ë³µ ìˆ˜?");
  addLog({name, kg:kg?Number(kg):"", reps:reps?Number(reps):"", sets:1});
};

document.getElementById("copyLast").onclick = ()=>{
  const data = store.load();
  const last = [...(data.workout||[])].reverse().find(x=>x.name);
  if(!last){ alert("ì§€ë‚œ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
  addLog({name:last.name, kg:last.kg, reps:last.reps, sets:last.sets||1});
};

// Voice logging
let recognizing=false, recog;

// Auto-log via URL (for NFC/Shortcuts): ?add=ë²¤ì¹˜í”„ë ˆìŠ¤&kg=80&reps=6
(function(){
  const params = new URLSearchParams(location.search);
  if(params.has('add')){
    const name = params.get('add');
    const kg = Number(params.get('kg'));
    const reps = Number(params.get('reps'));
    addLog({name, kg: isNaN(kg)? "": kg, reps: isNaN(reps)? "": reps, sets:1});
    history.replaceState({}, "", location.pathname);
    alert(`ìë™ ê¸°ë¡ë¨: ${name} ${kg||''}kg x ${reps||''}`);
  }
})();

// Mark current block done
document.getElementById("markDoneBtn").onclick = ()=>{
  const now = new Date();
  const active = dayBlocks.find(b=> now>=parseTime(b.start) && now<=parseTime(b.end) );
  if(!active){ alert("í˜„ì¬ í™œì„± ë¸”ë¡ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
  const data = store.load();
  const tkey = todayKey();
  data.blocks[tkey] = data.blocks[tkey]||{};
  data.blocks[tkey][active.key] = new Date().toISOString();
  store.save(data);
  renderBlocks(); renderHistory();
};

document.getElementById("startWorkRoutineBtn").onclick = ()=>{
  const videoUrl = "https://www.youtube.com/channel/UCdBDazT4stViix4CJ0dE26g";
  window.open(videoUrl, "_blank");
};

function renderHistory(){
  const data = store.load();
  const tkey = todayKey();
  const doneCount = Object.values(data.blocks[tkey]||{}).length;
  document.getElementById("todaySummary").textContent = `ì˜¤ëŠ˜ ì™„ë£Œ ${doneCount}/${dayBlocks.length}`;

  const container=document.getElementById("history");
  container.innerHTML="";
  const recent = (data.workout||[]).slice(-8).reverse();
  recent.forEach(e=>{
    const div=document.createElement("div");
    div.className="block";
    div.innerHTML = `<div><div>${e.name} ${e.kg||''}kg Ã— ${e.reps||''}</div>
      <div class="tiny muted">${e.date} ${e.time.slice(11,19)}</div></div>
      <button class="btn ghost">ì‚­ì œ</button>`;
    div.querySelector("button").onclick=()=>{
      const d = store.load();
      d.workout = d.workout.filter(x=> !(x.date===e.date && x.time===e.time) );
      store.save(d); renderWorkout(); renderHistory();
    }
    container.appendChild(div);
  });
}

// Export CSV
document.getElementById("exportCSV").onclick = ()=>{
  const data = store.load();
  let csv = "type,date,time,name,kg,reps,sets,key\n";
  (data.workout||[]).forEach(e=>{
    csv += `workout,${e.date},${e.time},${e.name||""},${e.kg||""},${e.reps||""},${e.sets||1},\n`;
  });
  Object.entries(data.blocks||{}).forEach(([d,keys])=>{
    Object.entries(keys).forEach(([k,t])=>{
      csv += `block,${d},${t},,,,"",${k}\n`;
    });
  });
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "routine_logs.csv"; a.click();
  URL.revokeObjectURL(url);
};

function renderAll(){ renderBlocks(); renderWorkout(); renderHistory(); }
renderAll(); setInterval(()=>renderBlocks(), 30000);

// Register SW
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  });
}
</script>
</body>
</html>
